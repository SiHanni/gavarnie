worker_processes  1;
error_log         /var/log/nginx/error.log warn;
pid               /var/run/nginx.pid;

events { worker_connections 1024; }

http {
  include       /etc/nginx/mime.types;
  default_type  application/octet-stream;

  sendfile        on;
  keepalive_timeout  65;

  server {
    listen 80;

    # ----- CORS (개발용: 와일드카드) -----
    add_header Access-Control-Allow-Origin "*" always;
    add_header Access-Control-Allow-Methods "GET, HEAD, OPTIONS" always;
    add_header Access-Control-Allow-Headers "Range, Origin, Accept, Content-Type, User-Agent, Cache-Control, If-Range, Authorization" always;
    add_header Access-Control-Expose-Headers "Content-Length, Content-Range, Accept-Ranges, ETag" always;
    add_header Vary "Origin" always;
    add_header Accept-Ranges bytes always;

    # Preflight
    if ($request_method = OPTIONS) {
      return 204;
    }

    # ----- HLS/미디어 프록시: /media/* -> MinIO bucket "media" -----
    location /media/ {
      # 이 location에 한해서 HLS MIME 지정 (전역 타입을 덮어쓰지 않도록)
      types {
        application/vnd.apple.mpegurl m3u8;
        video/mp2t                  ts;
      }

      # 캐시 정책(개발용: 짧게). 운영 전환 시 조정 권장
      # m3u8은 거의 실시간 인덱스이므로 매우 짧거나 no-store
      if ($request_uri ~* \.m3u8$) {
        add_header Cache-Control "no-store, must-revalidate" always;
      }
      if ($request_uri ~* \.ts$) {
        add_header Cache-Control "public, max-age=60" always;
      }

      # 업스트림(컨테이너 네임 해석)으로 프록시
      proxy_http_version 1.1;
      proxy_set_header   Connection "";
      proxy_set_header   Host minio;            # path-style 사용 시 안전하게 minio로 고정
      proxy_set_header   Range $http_range;     # 부분 요청 전달
      proxy_set_header   If-Range $http_if_range;
      proxy_set_header   Authorization $http_authorization;

      proxy_read_timeout   300s;   # 큰 조각/느린 디스크 대비
      proxy_send_timeout   300s;
      proxy_buffering      off;    # 스트리밍 버퍼링 비활성화
      proxy_request_buffering off;
      proxy_redirect       off;

      # /media/ 프리픽스를 제거하고 MinIO의 /media/ 버킷으로 전달
      proxy_pass http://minio:9000/media/;
    }
  }
}
